/*
 * Developed by M.MEHDI - Zenika
 */

node {

// Stage : Specifiyng the envrionment variables which will be used during the build process

    stage 'Defining Envrionment Variables'

        //Specifiyng the JDK tool (should be configured in Jenkins)
        env.JAVA_HOME="${tool 'JDK8'}"

        //Maven (should be configured in Jenkins)
        def mvnHome = tool "Maven 3.x"
 
// Stage : Build phase  

    stage 'Build'

        // getting the project from github :   
        git url: 'https://github.com/mahmoudmahdi24/atmosphere-calculator'

        // packaging the project using Maven :    
        sh "${mvnHome}/bin/mvn clean package"

// Stage : Unit testing phase 

    stage 'Unit Tests'

        //launching unit tests :
        sh "${mvnHome}/bin/mvn test"

        //saving the unit tests report : 
        step([$class: 'JUnitResultArchiver', testResults: '**/target/surefire-reports/TEST-*.xml'])

// Stage : Building a docker image of the project

    stage 'Build Docker image'
    
        //building the docker image by specifiying the snapshot name which is already specified in the POM.xml
    def image = docker.build('mahmoudmahdi24/atmo-calc:snapshot', '.')
  

 //  Stage : Running acceptance test
    stage 'Acceptance Tests'
        sh"${mvnHome}/bin/mvn exec:java -Dexec.mainClass="com.chelonix.atmocalc.server.Main"
        
        image.withRun('-p 8181:8181') {c ->
            sh "${mvnHome}/bin/mvn verify"
        }

 //   step([$class: 'JUnitResultArchiver', testResults: '**/target/failsafe-reports/TEST-*.xml'])

// Stage : Pushing the docker image 
 //   stage 'Push Docker image'
 //   docker.withRegistry("https://hub.docker.com/r/dockermahmoud", "dockermahmoud") {
 //      image.push()
 //   }
}
